\begin{algorithm*}[!ht]
\caption{HybridNorec HyTM implementation; code for $T_k$ by process $p_i$}
\label{alg:inswrite2}
\begin{algorithmic}[1]
  	\begin{multicols}{2}
  	{
  	\footnotesize
	\Part{Shared objects}{
		\State $\ms{gsl}$, global sequence lock 
		%\Statex ~~~~~allows reads, writes
		\State $\ms{esl}$, extra sequence lock
		
	}\EndPart	
 	\Statex
 	\Part{Process local objects}{
 		\State $\ms{sl}_i$, process $p_i$'s local sequence lock
 		
 	}\EndPart
	\Statex
	\textbf{Code for fast-path transactions}	
	\Statex
	\Part{$\textit{start}_k()$}{
		\State $ \ms{l}   \gets \Read(\ms{esl})$
		\If {$\ms{l}.\lit{isLocked}()$}
		  \Return $A_k$ \EndReturn
		\EndIf
		
	}\EndPart
	\Statex
	%\Comment{In general, would it better to buffer writes in tryC?}
	\Part{$\textit{read}_k(X_j)$}{\quad\Comment{fast-path}
		
		\State $\textit{ov}_j := v_j.\Read()$ \Comment{cached read} 
		
		\Return $\textit{ov}_j$ \EndReturn
		
   	 }\EndPart
	\Statex
	\Part{$\textit{write}_k(X_j,v)$}{\quad\Comment{fast-path}
	
	\State $v_j.\Write(v)$ \Comment{cached write}
	\Return $\ok$ \EndReturn
		
   	}\EndPart
	\Statex
	
	%\Statex	
	\Part{$\textit{tryC}_k$()}{\quad\Comment{fast-path}
		%\Return $C_k$ \EndReturn
		\If{$\Wset(T_k)= \emptyset$}
			\Return $C_k$ \EndReturn 
		\EndIf
		\State $ \ms{l}   \gets \Read(\ms{gsl})$
		\If {$\ms{l} \mathrel{\&} 1$}
		  \Return $A_k$ \EndReturn
		\EndIf
		\State $\ms{gsl}.\lit{write}(l+2)$
		\State $\ms{commit-cache}_i$ \Comment{returns $C_k$}
		
   		
   	 }\EndPart		
   	 \Statex
	\Statex
	\textbf{Code for slow-path transactions}
	\Statex
	\Part{$\textit{start}_k()$}{
		\While {$\ms{sl}.\lit{isLocked}()$}
		  \State $ \ms{sl}   \gets \Read(\ms{gsl})$
		\EndWhile
		
	}\EndPart
	\Statex
	\Part{\Read$_k(X_j)$}\quad\Comment{slow-path}{
		  \If{$X_j\in \Wset(T_k)$}
		    \Return $\Wset(T_k).\lit{locate}(X_j)$ \EndReturn
		  \Else
		  \State $\textit{ov}_j := \Read(v_j)$ 
		  
		  \If{$\neg \lit{validate}()$}
			
			\Return $A_k$ \EndReturn
		  \EndIf
		  \State $\Rset(T_k) := \Rset(T_k)\cup\{X_j,or_j\}$
		  \Return $\textit{ov}_j$ \EndReturn
		
   	 }\EndPart
   	\newpage
	\Part{\Write$_k(X_j,v)$}\quad\Comment{slow-path}{
		
			\State $\textit{nv}_j := v$
			\State $\Wset(T_k) := \Wset(T_k)\cup\{X_j,nv_j\}$
			\Return $\ok$ \EndReturn
		
   	}\EndPart
	\Statex
	
	%\Statex	
	\Part{\TryC$_k$()}\quad\Comment{slow-path}{
		\If{$\Wset(T_k)= \emptyset$}
			\Return $C_k$ \EndReturn 
		\EndIf
				
		\If{$\neg\ms{gsl}$.CAS($sl$, $sl+1$)}\Comment{Lock gsl} 
		  \Return $A_k$  \EndReturn
		\EndIf
		\If{$\lit{validate}()$}
			\State $\ms{gsl}.\lit{write}(\ms{sl}+1)$
			\Return $A_k$ \EndReturn
		\EndIf
		\ForAll{$X_j \in \Wset(T_k)$}
	 		 \State  $v_j.\lit{write}(\textit{nv}_j)$
			 
		\EndFor		
		\State $\ms{gsl}.\lit{write}(\ms{sl}+1)$
		\State $\ms{esl}.\lit{write}(\ms{sl}+1)$
  		\Return $C_k$ \EndReturn
   	 }\EndPart		
	\Statex
	\Part{Function: $\lit{validate}()$}{
		
		\If{$\exists X_j \in Rset(T_k)$:$(\textit{or}_j\neq \Read(r_j))$}
			\Return $\false$ \EndReturn
		  \EndIf
		
		 \Return $\true$ \EndReturn
	}\EndPart
	
% 	
	}
	\end{multicols}
  \end{algorithmic}
\end{algorithm*}
